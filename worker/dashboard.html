<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Dashboard - AutoClean BD</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/worker.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header worker-header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-car-wash"></i>
                <span>AutoClean BD - Worker</span>
            </div>
            <div class="user-menu">
                <div class="user-info">
                    <i class="fas fa-user-tie"></i>
                    <span id="workerName">Worker</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar worker-sidebar">
            <nav class="sidebar-nav">
                <a href="#overview" class="nav-item active" data-section="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </a>
                <a href="#current-job" class="nav-item" data-section="current-job">
                    <i class="fas fa-tasks"></i>
                    <span>Current Job</span>
                </a>
                <a href="#job-history" class="nav-item" data-section="job-history">
                    <i class="fas fa-history"></i>
                    <span>Job History</span>
                </a>
                <a href="#schedule" class="nav-item" data-section="schedule">
                    <i class="fas fa-calendar"></i>
                    <span>Schedule</span>
                </a>
                <a href="#profile" class="nav-item" data-section="profile">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="dashboard-main">
            <!-- Overview Section -->
            <section id="overview" class="dashboard-section active">
                <div class="section-header">
                    <h1>Worker Overview</h1>
                    <p>Welcome! Here's your work summary and current status.</p>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalJobs">0</h3>
                            <p>Total Jobs</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="completedJobs">0</h3>
                            <p>Completed</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="currentStatus">Available</h3>
                            <p>Status</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="averageRating">4.5</h3>
                            <p>Rating</p>
                        </div>
                    </div>
                </div>

                <!-- Current Job Card -->
                <div class="current-job-card" id="currentJobCard" style="display: none;">
                    <div class="card-header">
                        <h2>Current Job</h2>
                        <span class="status-badge in-progress">In Progress</span>
                    </div>
                    <div class="job-details">
                        <div class="job-info">
                            <div class="info-item">
                                <span class="label">Booking ID:</span>
                                <span class="value" id="currentBookingId">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Customer:</span>
                                <span class="value" id="currentCustomer">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Service:</span>
                                <span class="value" id="currentService">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Address:</span>
                                <span class="value" id="currentAddress">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Phone:</span>
                                <span class="value" id="currentPhone">-</span>
                            </div>
                        </div>
                        <div class="job-actions">
                            <button class="btn-primary" onclick="startJob()">
                                <i class="fas fa-play"></i>
                                Start Job
                            </button>
                            <button class="btn-success" onclick="completeJob()">
                                <i class="fas fa-check"></i>
                                Complete Job
                            </button>
                            <button class="btn-secondary" onclick="contactCustomer()">
                                <i class="fas fa-phone"></i>
                                Contact Customer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- No Job Card -->
                <div class="no-job-card" id="noJobCard">
                    <div class="card-content">
                        <i class="fas fa-coffee"></i>
                        <h3>No Active Job</h3>
                        <p>You're currently available. New jobs will appear here when assigned.</p>
                        <button class="btn-primary" onclick="refreshJobs()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h2>Recent Activity</h2>
                    <div class="activity-list" id="activityList">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Current Job Section -->
            <section id="current-job" class="dashboard-section">
                <div class="section-header">
                    <h1>Current Job Details</h1>
                    <p>Manage your current assignment and update progress.</p>
                </div>

                <div class="job-details-container" id="currentJobDetails">
                    <!-- Current job details will be loaded here -->
                </div>
            </section>

            <!-- Job History Section -->
            <section id="job-history" class="dashboard-section">
                <div class="section-header">
                    <h1>Job History</h1>
                    <p>View all your completed jobs and performance history.</p>
                </div>

                <!-- Job History Table -->
                <div class="job-history-container">
                    <table class="job-history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Booking ID</th>
                                <th>Customer</th>
                                <th>Service</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody id="jobHistoryTableBody">
                            <!-- Job history will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Schedule Section -->
            <section id="schedule" class="dashboard-section">
                <div class="section-header">
                    <h1>Work Schedule</h1>
                    <p>View your upcoming assignments and work schedule.</p>
                </div>

                <div class="schedule-container">
                    <div class="schedule-filters">
                        <select id="scheduleFilter" onchange="filterSchedule()">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="schedule-list" id="scheduleList">
                        <!-- Schedule items will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Profile Section -->
            <section id="profile" class="dashboard-section">
                <div class="section-header">
                    <h1>Worker Profile</h1>
                    <p>View and update your profile information.</p>
                </div>

                <div class="profile-container">
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="profile-info">
                                <h3 id="profileName">Worker Name</h3>
                                <p id="profileStatus">Active</p>
                            </div>
                        </div>
                        <div class="profile-details">
                            <div class="detail-item">
                                <span class="label">Phone:</span>
                                <span class="value" id="profilePhone">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Email:</span>
                                <span class="value" id="profileEmail">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Total Jobs:</span>
                                <span class="value" id="profileTotalJobs">0</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Average Rating:</span>
                                <span class="value" id="profileRating">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Join Date:</span>
                                <span class="value" id="profileJoinDate">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Job Update Modal -->
    <div id="jobUpdateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Update Job Status</h2>
                <span class="close" onclick="closeJobUpdateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="jobUpdateForm">
                    <div class="form-group">
                        <label for="jobStatus">Job Status</label>
                        <select id="jobStatus" name="status" required>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on-hold">On Hold</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jobNotes">Notes (Optional)</label>
                        <textarea id="jobNotes" name="notes" rows="3" placeholder="Add any notes about the job progress..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i>
                            Update Status
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeJobUpdateModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Contact Customer Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Contact Customer</h2>
                <span class="close" onclick="closeContactModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-user"></i>
                        <span id="contactCustomerName">Customer Name</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <a href="tel:" id="contactCustomerPhone">+880 1234 567 890</a>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="contactCustomerAddress">Customer Address</span>
                    </div>
                </div>
                <div class="contact-actions">
                    <button class="btn-primary" onclick="callCustomer()">
                        <i class="fas fa-phone"></i>
                        Call Customer
                    </button>
                    <button class="btn-secondary" onclick="sendSMS()">
                        <i class="fas fa-sms"></i>
                        Send SMS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- JavaScript Code -->
    <script>
        // Authentication utilities for AutoClean BD
        const BASE_URL = (location.port && location.port !== '80' && location.port !== '443') ? 'http://localhost/web/' : (window.location.origin + '/web/');

        // Check if user is authenticated and has correct role
        function checkAuth(requiredRole = null) {
            const userData = localStorage.getItem('userData');
            const userType = localStorage.getItem('userType');
            
            if (!userData || !userType) {
                redirectToLogin();
                return null;
            }
            
            try {
                const user = JSON.parse(userData);
                
                if (requiredRole && user.user_type !== requiredRole) {
                    showToast('Access denied. You do not have permission to view this page.', 'error');
                    redirectToDashboard(user.user_type);
                    return null;
                }
                
                return user;
            } catch (error) {
                console.error('Error parsing user data:', error);
                localStorage.removeItem('userData');
                localStorage.removeItem('userType');
                redirectToLogin();
                return null;
            }
        }

        // Redirect to appropriate dashboard based on user type
        function redirectToDashboard(userType) {
            switch (userType) {
                case 'admin':
                    window.location.href = '../admin/dashboard.html';
                    break;
                case 'customer':
                    window.location.href = '../customer/dashboard.html';
                    break;
                case 'worker':
                    window.location.href = '../worker/dashboard.html';
                    break;
                default:
                    window.location.href = '../index.html';
            }
        }

        // Redirect to login page
        function redirectToLogin() {
            window.location.href = '../login.html';
        }

        // Logout function
        function logout() {
            fetch(`${BASE_URL}api/logout.php`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                localStorage.removeItem('userData');
                localStorage.removeItem('userType');
                showToast('Logged out successfully.', 'success');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1000);
            })
            .catch(error => {
                console.error('Logout error:', error);
                localStorage.removeItem('userData');
                localStorage.removeItem('userType');
                showToast('Logged out successfully.', 'success');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1000);
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            } else {
                alert(message);
            }
        }

        // Initialize authentication for dashboard pages
        function initAuth(requiredRole = null) {
            const user = checkAuth(requiredRole);
            if (user) {
                const userNameElement = document.getElementById('workerName');
                if (userNameElement && user) {
                    userNameElement.textContent = `${user.first_name} ${user.last_name}`;
                }
                return user;
            }
            return null;
        }

        // Worker Dashboard JavaScript
        let currentWorker = null;
        let workerData = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            currentWorker = initAuth('worker');
            if (!currentWorker) {
                return;
            }
            initializeNavigation();
            loadWorkerDashboard();
            setupEventListeners();
        });

        // Initialize navigation
        function initializeNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
        }

        // Show section
        function showSection(sectionId) {
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            switch(sectionId) {
                case 'overview':
                    loadWorkerDashboard();
                    break;
                case 'current-job':
                    loadCurrentJob();
                    break;
                case 'job-history':
                    loadJobHistory();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'profile':
                    loadProfile();
                    break;
            }
        }

        // Load worker dashboard data
        async function loadWorkerDashboard() {
            try {
                showLoading('overview');
                
                // Simulate worker data (in real app, this would come from API)
                const mockWorkerData = {
                    stats: {
                        totalJobs: 45,
                        completedJobs: 42,
                        currentStatus: 'Available'
                    },
                    currentJob: {
                        id: 'BK001',
                        customer: 'John Doe',
                        phone: '+880 1712345678',
                        service: 'Car Wash',
                        package: 'Premium',
                        address: 'House 123, Road 12, Bashundhara R/A, Dhaka',
                        scheduledDate: '2024-01-20',
                        scheduledTime: '10:00 AM',
                        status: 'in-progress'
                    },
                    recentJobs: [
                        {
                            id: 'BK001',
                            customer: 'John Doe',
                            service: 'Car Wash',
                            package: 'Premium',
                            date: '2024-01-20',
                            status: 'completed',
                            amount: '৳599'
                        },
                        {
                            id: 'BK002',
                            customer: 'Sarah Smith',
                            service: 'Bike Wash',
                            package: 'Basic',
                            date: '2024-01-19',
                            status: 'completed',
                            amount: '৳199'
                        }
                    ]
                };
                
                workerData = mockWorkerData;
                updateDashboardStats();
                updateCurrentJob();
                updateRecentJobs();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Failed to load dashboard data', 'error');
            } finally {
                hideLoading('overview');
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            if (!workerData) return;
            
            document.getElementById('totalJobs').textContent = workerData.stats.totalJobs;
            document.getElementById('completedJobs').textContent = workerData.stats.completedJobs;
            document.getElementById('currentStatus').textContent = workerData.stats.currentStatus;
        }

        // Update current job
        function updateCurrentJob() {
            if (!workerData || !workerData.currentJob) return;
            
            const job = workerData.currentJob;
            
            document.getElementById('currentBookingId').textContent = job.id;
            document.getElementById('currentCustomer').textContent = job.customer;
            document.getElementById('currentPhone').textContent = job.phone;
            document.getElementById('currentService').textContent = job.service;
            document.getElementById('currentAddress').textContent = job.address;
            document.getElementById('currentDateTime').textContent = `${job.scheduledDate} ${job.scheduledTime}`;
            document.getElementById('currentJobStatus').textContent = job.status;
        }

        // Update recent jobs
        function updateRecentJobs() {
            if (!workerData) return;
            
            const container = document.getElementById('recentJobsList');
            container.innerHTML = '';
            
            if (workerData.recentJobs.length === 0) {
                container.innerHTML = '<p class="no-data">No recent jobs found.</p>';
                return;
            }
            
            workerData.recentJobs.forEach(job => {
                const jobItem = createJobItem(job);
                container.appendChild(jobItem);
            });
        }

        // Create job item
        function createJobItem(job) {
            const div = document.createElement('div');
            div.className = 'job-item';
            
            const statusClass = `status-${job.status}`;
            const statusText = job.status.charAt(0).toUpperCase() + job.status.slice(1);
            
            div.innerHTML = `
                <div class="job-header">
                    <span class="job-id">${job.id}</span>
                    <span class="job-status ${statusClass}">${statusText}</span>
                </div>
                <div class="job-details">
                    <div class="job-detail">
                        <span class="label">Customer</span>
                        <span class="value">${job.customer}</span>
                    </div>
                    <div class="job-detail">
                        <span class="label">Service</span>
                        <span class="value">${job.service}</span>
                    </div>
                    <div class="job-detail">
                        <span class="label">Package</span>
                        <span class="value">${job.package}</span>
                    </div>
                    <div class="job-detail">
                        <span class="label">Date</span>
                        <span class="value">${job.date}</span>
                    </div>
                    <div class="job-detail">
                        <span class="label">Amount</span>
                        <span class="value">${job.amount}</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Load current job
        async function loadCurrentJob() {
            try {
                showLoading('current-job');
                
                // Simulate API call
                setTimeout(() => {
                    updateCurrentJob();
                    hideLoading('current-job');
                }, 1000);
                
            } catch (error) {
                console.error('Error loading current job:', error);
                showToast('Failed to load current job', 'error');
            }
        }

        // Load job history
        async function loadJobHistory() {
            try {
                showLoading('job-history');
                
                // Simulate API call
                setTimeout(() => {
                    updateJobHistoryTable(workerData.recentJobs);
                    hideLoading('job-history');
                }, 1000);
                
            } catch (error) {
                console.error('Error loading job history:', error);
                showToast('Failed to load job history', 'error');
            }
        }

        // Update job history table
        function updateJobHistoryTable(jobs) {
            const tbody = document.getElementById('jobHistoryTableBody');
            tbody.innerHTML = '';
            
            if (jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No job history found.</td></tr>';
                return;
            }
            
            jobs.forEach(job => {
                const row = createJobHistoryRow(job);
                tbody.appendChild(row);
            });
        }

        // Create job history row
        function createJobHistoryRow(job) {
            const tr = document.createElement('tr');
            
            const statusClass = `status-${job.status}`;
            const statusText = job.status.charAt(0).toUpperCase() + job.status.slice(1);
            
            tr.innerHTML = `
                <td>${job.id}</td>
                <td>${job.customer}</td>
                <td>${job.service}</td>
                <td>${job.package}</td>
                <td>${job.date}</td>
                <td><span class="job-status ${statusClass}">${statusText}</span></td>
                <td>${job.amount}</td>
            `;
            
            return tr;
        }

        // Load schedule
        async function loadSchedule() {
            try {
                showLoading('schedule');
                
                // Simulate schedule data
                const scheduleData = [
                    {
                        date: '2024-01-20',
                        time: '10:00 AM',
                        customer: 'John Doe',
                        service: 'Car Wash',
                        package: 'Premium',
                        status: 'scheduled'
                    },
                    {
                        date: '2024-01-21',
                        time: '2:00 PM',
                        customer: 'Sarah Smith',
                        service: 'Bike Wash',
                        package: 'Basic',
                        status: 'scheduled'
                    }
                ];
                
                updateScheduleList(scheduleData);
                
            } catch (error) {
                console.error('Error loading schedule:', error);
                showToast('Failed to load schedule', 'error');
            } finally {
                hideLoading('schedule');
            }
        }

        // Update schedule list
        function updateScheduleList(schedule) {
            const container = document.getElementById('scheduleList');
            container.innerHTML = '';
            
            if (schedule.length === 0) {
                container.innerHTML = '<p class="no-data">No scheduled jobs found.</p>';
                return;
            }
            
            schedule.forEach(item => {
                const scheduleItem = createScheduleItem(item);
                container.appendChild(scheduleItem);
            });
        }

        // Create schedule item
        function createScheduleItem(item) {
            const div = document.createElement('div');
            div.className = 'schedule-item';
            
            div.innerHTML = `
                <div class="schedule-header">
                    <span class="schedule-date">${item.date}</span>
                    <span class="schedule-time">${item.time}</span>
                </div>
                <div class="schedule-details">
                    <div class="schedule-detail">
                        <span class="label">Customer</span>
                        <span class="value">${item.customer}</span>
                    </div>
                    <div class="schedule-detail">
                        <span class="label">Service</span>
                        <span class="value">${item.service}</span>
                    </div>
                    <div class="schedule-detail">
                        <span class="label">Package</span>
                        <span class="value">${item.package}</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Load profile
        function loadProfile() {
            if (!currentWorker) return;
            
            document.getElementById('profileName').textContent = `${currentWorker.first_name} ${currentWorker.last_name}`;
            document.getElementById('profilePhone').textContent = currentWorker.phone;
            document.getElementById('profileEmail').textContent = currentWorker.email;
            document.getElementById('profileTotalJobs').textContent = currentWorker.total_jobs || 0;
            document.getElementById('profileRating').textContent = currentWorker.average_rating || 'N/A';
            document.getElementById('profileJoinDate').textContent = currentWorker.join_date || 'N/A';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Profile form submission
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', handleProfileUpdate);
            }
            
            // Job status update buttons
            const startJobBtn = document.getElementById('startJobBtn');
            const completeJobBtn = document.getElementById('completeJobBtn');
            
            if (startJobBtn) {
                startJobBtn.addEventListener('click', startJob);
            }
            
            if (completeJobBtn) {
                completeJobBtn.addEventListener('click', completeJob);
            }
        }

        // Handle profile update
        async function handleProfileUpdate(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const profileData = {
                userId: currentWorker.id,
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                address: formData.get('address'),
                specialization: formData.get('specialization')
            };
            
            try {
                const response = await fetch(`${BASE_URL}api/update_profile.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(profileData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Profile updated successfully!', 'success');
                    currentWorker = data.data;
                    localStorage.setItem('userData', JSON.stringify(data.data));
                    document.getElementById('profileName').textContent = `${data.data.first_name} ${data.data.last_name}`;
                    document.getElementById('profilePhone').textContent = data.data.phone;
                    document.getElementById('profileEmail').textContent = data.data.email;
                    document.getElementById('profileTotalJobs').textContent = data.data.total_jobs || 0;
                    document.getElementById('profileRating').textContent = data.data.average_rating || 'N/A';
                    document.getElementById('profileJoinDate').textContent = data.data.join_date || 'N/A';
                } else {
                    showToast(data.message || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Failed to update profile', 'error');
            }
        }

        // Start job
        async function startJob() {
            if (!workerData.currentJob) {
                showToast('No current job to start', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}api/update_booking_status.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bookingId: workerData.currentJob.id,
                        status: 'in-progress',
                        notes: 'Worker started the job'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Job started successfully!', 'success');
                    workerData.currentJob.status = 'in-progress';
                    updateCurrentJob();
                    document.getElementById('currentJobStatus').textContent = 'in-progress';
                } else {
                    showToast(data.message || 'Failed to start job', 'error');
                }
            } catch (error) {
                console.error('Error starting job:', error);
                showToast('Failed to start job', 'error');
            }
        }

        // Complete job
        async function completeJob() {
            if (!workerData.currentJob) {
                showToast('No current job to complete', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}api/update_booking_status.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bookingId: workerData.currentJob.id,
                        status: 'completed',
                        notes: 'Job completed by worker'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Job completed successfully!', 'success');
                    workerData.currentJob.status = 'completed';
                    updateCurrentJob();
                    document.getElementById('currentJobStatus').textContent = 'completed';
                    
                    // Refresh dashboard data
                    setTimeout(() => {
                        loadWorkerDashboard();
                    }, 2000);
                } else {
                    showToast(data.message || 'Failed to complete job', 'error');
                }
            } catch (error) {
                console.error('Error completing job:', error);
                showToast('Failed to complete job', 'error');
            }
        }

        // Reset profile form
        function resetProfileForm() {
            loadProfile();
        }

        // Refresh jobs
        function refreshJobs() {
            loadWorkerDashboard();
        }

        // Loading functions
        function showLoading(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('loading');
            }
        }

        function hideLoading(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('loading');
            }
        }
    </script>
</body>
</html> 
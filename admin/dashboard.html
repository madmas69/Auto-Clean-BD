<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AutoClean BD</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header admin-header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-car-wash"></i>
                <span>AutoClean BD - Admin</span>
            </div>
            <div class="user-menu">
                <div class="user-info">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminName">Administrator</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar admin-sidebar">
            <nav class="sidebar-nav">
                <a href="#overview" class="nav-item active" data-section="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </a>
                <a href="#bookings" class="nav-item" data-section="bookings">
                    <i class="fas fa-calendar-check"></i>
                    <span>Bookings</span>
                </a>
                <a href="#workers" class="nav-item" data-section="workers">
                    <i class="fas fa-users"></i>
                    <span>Workers</span>
                </a>
                <a href="#packages" class="nav-item" data-section="packages">
                    <i class="fas fa-box"></i>
                    <span>Service Packages</span>
                </a>
                <a href="#customers" class="nav-item" data-section="customers">
                    <i class="fas fa-user-friends"></i>
                    <span>Customers</span>
                </a>
                <a href="#reports" class="nav-item" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="#messages" class="nav-item" data-section="messages">
                    <i class="fas fa-envelope"></i>
                    <span>Messages</span>
                    <span class="badge" id="unreadCount">0</span>
                </a>
                <a href="#settings" class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="dashboard-main">
            <!-- Overview Section -->
            <section id="overview" class="dashboard-section active">
                <div class="section-header">
                    <h1>Admin Overview</h1>
                    <p>System statistics and recent activity overview.</p>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalBookings">0</h3>
                            <p>Total Bookings</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="pendingBookings">0</h3>
                            <p>Pending</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="completedBookings">0</h3>
                            <p>Completed</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalRevenue">à§³0</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="activeWorkers">0</h3>
                            <p>Active Workers</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalCustomers">0</h3>
                            <p>Total Customers</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Bookings -->
                <div class="recent-bookings">
                    <div class="section-title">
                        <h2>Recent Bookings</h2>
                        <a href="#bookings" class="view-all-btn">View All</a>
                    </div>
                    <div class="bookings-list" id="recentBookingsList">
                        <!-- Bookings will be loaded here -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h2>Quick Actions</h2>
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="showSection('workers')">
                            <i class="fas fa-user-plus"></i>
                            Add Worker
                        </button>
                        <button class="action-btn primary" onclick="showSection('packages')">
                            <i class="fas fa-plus"></i>
                            Add Package
                        </button>
                        <button class="action-btn secondary" onclick="showSection('bookings')">
                            <i class="fas fa-tasks"></i>
                            Manage Bookings
                        </button>
                        <button class="action-btn secondary" onclick="showSection('messages')">
                            <i class="fas fa-envelope"></i>
                            View Messages
                        </button>
                    </div>
                </div>
            </section>

            <!-- Bookings Section -->
            <section id="bookings" class="dashboard-section">
                <div class="section-header">
                    <h1>Booking Management</h1>
                    <p>Manage all customer bookings and assign workers.</p>
                </div>

                <!-- Booking Filters -->
                <div class="booking-filters">
                    <select id="statusFilter" onchange="filterBookings()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <button class="refresh-btn" onclick="loadBookings()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>

                <!-- Bookings Table -->
                <div class="bookings-table-container">
                    <table class="bookings-table">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Service</th>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Worker</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody">
                            <!-- Bookings will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Workers Section -->
            <section id="workers" class="dashboard-section">
                <div class="section-header">
                    <h1>Worker Management</h1>
                    <p>Manage service workers and their assignments.</p>
                </div>

                <!-- Add Worker Button -->
                <div class="section-actions">
                    <button class="btn-primary" onclick="openAddWorkerModal()">
                        <i class="fas fa-plus"></i>
                        Add New Worker
                    </button>
                </div>

                <!-- Workers Table -->
                <div class="workers-table-container">
                    <table class="workers-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Current Job</th>
                                <th>Completed Jobs</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="workersTableBody">
                            <!-- Workers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Packages Section -->
            <section id="packages" class="dashboard-section">
                <div class="section-header">
                    <h1>Service Packages</h1>
                    <p>Manage service packages and pricing.</p>
                </div>

                <!-- Add Package Button -->
                <div class="section-actions">
                    <button class="btn-primary" onclick="openAddPackageModal()">
                        <i class="fas fa-plus"></i>
                        Add New Package
                    </button>
                </div>

                <!-- Packages Grid -->
                <div class="packages-grid" id="packagesGrid">
                    <!-- Packages will be loaded here -->
                </div>
            </section>

            <!-- Customers Section -->
            <section id="customers" class="dashboard-section">
                <div class="section-header">
                    <h1>Customer Management</h1>
                    <p>View and manage customer information.</p>
                </div>

                <!-- Customers Table -->
                <div class="customers-table-container">
                    <table class="customers-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Total Bookings</th>
                                <th>Total Spent</th>
                                <th>Last Booking</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="dashboard-section">
                <div class="section-header">
                    <h1>Reports & Analytics</h1>
                    <p>View detailed reports and analytics.</p>
                </div>

                <div class="reports-grid">
                    <div class="report-card">
                        <h3>Revenue Report</h3>
                        <div class="report-content">
                            <div class="report-stat">
                                <span class="stat-label">Today's Revenue</span>
                                <span class="stat-value" id="todayRevenue">à§³0</span>
                            </div>
                            <div class="report-stat">
                                <span class="stat-label">This Week</span>
                                <span class="stat-value" id="weekRevenue">à§³0</span>
                            </div>
                            <div class="report-stat">
                                <span class="stat-label">This Month</span>
                                <span class="stat-value" id="monthRevenue">à§³0</span>
                            </div>
                        </div>
                    </div>
                    <div class="report-card">
                        <h3>Booking Statistics</h3>
                        <div class="report-content">
                            <div class="report-stat">
                                <span class="stat-label">Today's Bookings</span>
                                <span class="stat-value" id="todayBookings">0</span>
                            </div>
                            <div class="report-stat">
                                <span class="stat-label">This Week</span>
                                <span class="stat-value" id="weekBookings">0</span>
                            </div>
                            <div class="report-stat">
                                <span class="stat-label">This Month</span>
                                <span class="stat-value" id="monthBookings">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="report-card">
                        <h3>Worker Performance</h3>
                        <div class="report-content" id="workerPerformance">
                            <!-- Worker performance will be loaded here -->
                        </div>
                    </div>
                    <div class="report-card">
                        <h3>Popular Services</h3>
                        <div class="report-content" id="popularServices">
                            <!-- Popular services will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Messages Section -->
            <section id="messages" class="dashboard-section">
                <div class="section-header">
                    <h1>Contact Messages</h1>
                    <p>View and respond to customer messages.</p>
                </div>

                <div class="messages-container">
                    <div class="messages-list" id="messagesList">
                        <!-- Messages will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="dashboard-section">
                <div class="section-header">
                    <h1>System Settings</h1>
                    <p>Configure system settings and preferences.</p>
                </div>

                <div class="settings-container">
                    <div class="settings-card">
                        <h3>General Settings</h3>
                        <form class="settings-form">
                            <div class="form-group">
                                <label>Business Hours</label>
                                <div class="time-range">
                                    <input type="time" value="09:00">
                                    <span>to</span>
                                    <input type="time" value="18:00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Service Area</label>
                                <input type="text" value="Bashundhara Residential Area, Dhaka">
                            </div>
                            <div class="form-group">
                                <label>Contact Email</label>
                                <input type="email" value="admin@autocleanbd.com">
                            </div>
                            <div class="form-group">
                                <label>Contact Phone</label>
                                <input type="tel" value="+880 1234 567 890">
                            </div>
                            <button type="submit" class="btn-primary">Save Settings</button>
                        </form>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Worker Modal -->
    <div id="addWorkerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Worker</h2>
                <span class="close" onclick="closeAddWorkerModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addWorkerForm">
                    <div class="form-group">
                        <label for="workerName">Full Name</label>
                        <input type="text" id="workerName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="workerPhone">Phone Number</label>
                        <input type="tel" id="workerPhone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="workerEmail">Email (Optional)</label>
                        <input type="email" id="workerEmail" name="email">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-plus"></i>
                            Add Worker
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeAddWorkerModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Package Modal -->
    <div id="addPackageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Service Package</h2>
                <span class="close" onclick="closeAddPackageModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addPackageForm">
                    <div class="form-group">
                        <label for="packageName">Package Name</label>
                        <input type="text" id="packageName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="packageDescription">Description</label>
                        <textarea id="packageDescription" name="description" rows="3" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carPrice">Car Price (à§³)</label>
                            <input type="number" id="carPrice" name="carPrice" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="bikePrice">Bike Price (à§³)</label>
                            <input type="number" id="bikePrice" name="bikePrice" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (minutes)</label>
                        <input type="number" id="duration" name="duration" min="1" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-plus"></i>
                            Add Package
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeAddPackageModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Worker Modal -->
    <div id="assignWorkerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assign Worker</h2>
                <span class="close" onclick="closeAssignWorkerModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="assignWorkerForm">
                    <input type="hidden" id="assignBookingId" name="bookingId">
                    <div class="form-group">
                        <label for="assignWorkerId">Select Worker</label>
                        <select id="assignWorkerId" name="workerId" required>
                            <option value="">Select a worker</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assignNotes">Notes (Optional)</label>
                        <textarea id="assignNotes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-user-plus"></i>
                            Assign Worker
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeAssignWorkerModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div id="updateStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Update Booking Status</h2>
                <span class="close" onclick="closeUpdateStatusModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <input type="hidden" id="statusBookingId" name="bookingId">
                    <div class="form-group">
                        <label for="newStatus">New Status</label>
                        <select id="newStatus" name="status" required>
                            <option value="">Select status</option>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="statusNotes">Notes (Optional)</label>
                        <textarea id="statusNotes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i>
                            Update Status
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeUpdateStatusModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- JavaScript Code -->
    <script>
        // Authentication utilities for AutoClean BD
        const BASE_URL = (location.port && location.port !== '80' && location.port !== '443') ? 'http://localhost/web/' : (window.location.origin + '/web/');

        // Check if user is authenticated and has correct role
        function checkAuth(requiredRole = null) {
            const userData = localStorage.getItem('userData');
            if (!userData) {
                redirectToLogin();
                return null;
            }
            try {
                const user = JSON.parse(userData);
                if (!user || !user.user_type) {
                    throw new Error('Invalid user data');
                }
                if (requiredRole && user.user_type !== requiredRole) {
                    showToast('Access denied. You do not have permission to view this page.', 'error');
                    redirectToDashboard(user.user_type);
                    return null;
                }
                return user;
            } catch (error) {
                console.error('Error parsing user data:', error);
                localStorage.removeItem('userData');
                localStorage.removeItem('userType');
                redirectToLogin();
                return null;
            }
        }

        // Redirect to appropriate dashboard based on user type
        function redirectToDashboard(userType) {
            switch (userType) {
                case 'admin':
                    window.location.href = '../admin/dashboard.html';
                    break;
                case 'customer':
                    window.location.href = '../customer/dashboard.html';
                    break;
                case 'worker':
                    window.location.href = '../worker/dashboard.html';
                    break;
                default:
                    window.location.href = '../index.html';
            }
        }

        // Redirect to login page
        function redirectToLogin() {
            window.location.href = '../login.html';
        }

        // Logout function
        function logout() {
            fetch(`${BASE_URL}api/logout.php`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                localStorage.removeItem('userData');
                localStorage.removeItem('userType');
                showToast('Logged out successfully.', 'success');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1000);
            })
            .catch(error => {
                console.error('Logout error:', error);
                localStorage.removeItem('userData');
                localStorage.removeItem('userType');
                showToast('Logged out successfully.', 'success');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1000);
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            } else {
                alert(message);
            }
        }

        // Initialize authentication for dashboard pages
        function initAuth(requiredRole = null) {
            const user = checkAuth(requiredRole);
            if (user) {
                const adminNameElement = document.getElementById('adminName');
                if (adminNameElement && user) {
                    adminNameElement.textContent = `${user.first_name} ${user.last_name}`;
                }
                return user;
            }
            return null;
        }

        // Admin Dashboard JavaScript
        let currentAdmin = null;
        let adminData = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            currentAdmin = initAuth('admin');
            if (!currentAdmin) {
                return;
            }
            initializeNavigation();
            loadAdminDashboard();
            setupEventListeners();
        });

        // Initialize navigation
        function initializeNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
        }

        // Show section
        function showSection(sectionId) {
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            switch(sectionId) {
                case 'overview':
                    loadAdminDashboard();
                    break;
                case 'bookings':
                    loadBookings();
                    break;
                case 'workers':
                    loadWorkers();
                    break;
                case 'packages':
                    loadPackages();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'messages':
                    loadMessages();
                    break;
            }
        }

        // Load admin dashboard data
        async function loadAdminDashboard() {
            try {
                showLoading('overview');
                
                const response = await fetch(`${BASE_URL}api/get_admin_dashboard.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    adminData = data.data;
                    updateDashboardStats();
                    updateRecentBookings();
                } else {
                    showToast(data.message || 'Failed to load dashboard data', 'error');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Failed to load dashboard data', 'error');
            } finally {
                hideLoading('overview');
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            if (!adminData) return;
            
            document.getElementById('totalBookings').textContent = adminData.stats.totalBookings;
            document.getElementById('pendingBookings').textContent = adminData.stats.pendingBookings;
            document.getElementById('completedBookings').textContent = adminData.stats.completedBookings;
            document.getElementById('totalRevenue').textContent = adminData.stats.totalRevenue;
            document.getElementById('totalCustomers').textContent = adminData.stats.totalCustomers;
            const workersValue = adminData.stats.totalWorkers ?? adminData.stats.activeWorkers ?? 0;
            const activeWorkersEl = document.getElementById('activeWorkers');
            if (activeWorkersEl) activeWorkersEl.textContent = workersValue;
        }

        // Update recent bookings
        function updateRecentBookings() {
            if (!adminData) return;
            
            const container = document.getElementById('recentBookingsList');
            container.innerHTML = '';
            
            if (adminData.recentBookings.length === 0) {
                container.innerHTML = '<p class="no-data">No recent bookings found.</p>';
                return;
            }
            
            adminData.recentBookings.forEach(booking => {
                const bookingItem = createBookingItem(booking);
                container.appendChild(bookingItem);
            });
        }

        // Create booking item
        function createBookingItem(booking) {
            const div = document.createElement('div');
            div.className = 'booking-item';
            
            const statusClass = `status-${booking.status}`;
            const statusText = booking.status.charAt(0).toUpperCase() + booking.status.slice(1);
            
            div.innerHTML = `
                <div class="booking-header">
                    <span class="booking-id">${booking.id}</span>
                    <span class="booking-status ${statusClass}">${statusText}</span>
                </div>
                <div class="booking-details">
                    <div class="booking-detail">
                        <span class="label">Customer</span>
                        <span class="value">${booking.customerName}</span>
                    </div>
                    <div class="booking-detail">
                        <span class="label">Service</span>
                        <span class="value">${booking.service}</span>
                    </div>
                    <div class="booking-detail">
                        <span class="label">Date</span>
                        <span class="value">${booking.scheduledDate}</span>
                    </div>
                    <div class="booking-detail">
                        <span class="label">Amount</span>
                        <span class="value">${booking.amount}</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Load bookings
        async function loadBookings() {
            try {
                showLoading('bookings');
                
                const response = await fetch(`${BASE_URL}api/get_admin_dashboard.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateBookingsTable(data.data.allBookings);
                } else {
                    showToast(data.message || 'Failed to load bookings', 'error');
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                showToast('Failed to load bookings', 'error');
            } finally {
                hideLoading('bookings');
            }
        }

        // Update bookings table
        function updateBookingsTable(bookings) {
            const tbody = document.getElementById('bookingsTableBody');
            tbody.innerHTML = '';
            
            if (bookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No bookings found.</td></tr>';
                return;
            }
            
            bookings.forEach(booking => {
                const row = createBookingRow(booking);
                tbody.appendChild(row);
            });
        }

        // Create booking row
        function createBookingRow(booking) {
            const tr = document.createElement('tr');
            
            const statusClass = `status-${booking.status}`;
            const statusText = booking.status.charAt(0).toUpperCase() + booking.status.slice(1);
            
            tr.innerHTML = `
                <td>${booking.id}</td>
                <td>${booking.customerName}</td>
                <td>${booking.service}</td>
                <td>${booking.scheduledDate} ${booking.scheduledTime}</td>
                <td><span class="booking-status ${statusClass}">${statusText}</span></td>
                <td>${booking.worker || 'Unassigned'}</td>
                <td>${booking.amount}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn secondary" onclick="viewBooking('${booking.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn primary" onclick="assignWorker('${booking.id}')">
                            <i class="fas fa-user-plus"></i>
                        </button>
                        <button class="action-btn warning" onclick="updateStatus('${booking.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return tr;
        }

        // Load workers
        async function loadWorkers() {
            try {
                showLoading('workers');
                
                const response = await fetch(`${BASE_URL}api/get_admin_dashboard.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateWorkersTable(data.data.workers);
                } else {
                    showToast(data.message || 'Failed to load workers', 'error');
                }
            } catch (error) {
                console.error('Error loading workers:', error);
                showToast('Failed to load workers', 'error');
            } finally {
                hideLoading('workers');
            }
        }

        // Update workers table
        function updateWorkersTable(workers) {
            const tbody = document.getElementById('workersTableBody');
            tbody.innerHTML = '';
            
            if (workers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No workers found.</td></tr>';
                return;
            }
            
            workers.forEach(worker => {
                const row = createWorkerRow(worker);
                tbody.appendChild(row);
            });
        }

        // Create worker row
        function createWorkerRow(worker) {
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>${worker.id}</td>
                <td>${worker.name}</td>
                <td>${worker.phone}</td>
                <td>${worker.status}</td>
                <td>${worker.completedJobs}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn secondary" onclick="viewWorker('${worker.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn primary" onclick="editWorker('${worker.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return tr;
        }

        // Load packages
        async function loadPackages() {
            try {
                showLoading('packages');
                
                const response = await fetch(`${BASE_URL}api/get_admin_dashboard.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updatePackagesTable(data.data.packages);
                } else {
                    showToast(data.message || 'Failed to load packages', 'error');
                }
            } catch (error) {
                console.error('Error loading packages:', error);
                showToast('Failed to load packages', 'error');
            } finally {
                hideLoading('packages');
            }
        }

        // Update packages table
        function updatePackagesTable(packages) {
            const tbody = document.getElementById('packagesTableBody');
            tbody.innerHTML = '';
            
            if (packages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No packages found.</td></tr>';
                return;
            }
            
            packages.forEach(package => {
                const row = createPackageRow(package);
                tbody.appendChild(row);
            });
        }

        // Create package row
        function createPackageRow(package) {
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>${package.id}</td>
                <td>${package.name}</td>
                <td>${package.description}</td>
                <td>${package.carPrice}</td>
                <td>${package.bikePrice}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn secondary" onclick="viewPackage('${package.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn primary" onclick="editPackage('${package.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn danger" onclick="deletePackage('${package.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return tr;
        }

        // Load customers
        async function loadCustomers() {
            try {
                showLoading('customers');
                
                const response = await fetch(`${BASE_URL}api/get_admin_dashboard.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateCustomersTable(data.data.customers);
                } else {
                    showToast(data.message || 'Failed to load customers', 'error');
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                showToast('Failed to load customers', 'error');
            } finally {
                hideLoading('customers');
            }
        }

        // Update customers table
        function updateCustomersTable(customers) {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            
            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No customers found.</td></tr>';
                return;
            }
            
            customers.forEach(customer => {
                const row = createCustomerRow(customer);
                tbody.appendChild(row);
            });
        }

        // Create customer row
        function createCustomerRow(customer) {
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>${customer.id}</td>
                <td>${customer.name}</td>
                <td>${customer.email}</td>
                <td>${customer.phone}</td>
                <td>${customer.totalBookings}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn secondary" onclick="viewCustomer('${customer.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn primary" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return tr;
        }

        // Load reports
        async function loadReports() {
            try {
                showLoading('reports');
                
                const response = await fetch(`${BASE_URL}api/get_admin_dashboard.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateReportsData(data.data.reports);
                } else {
                    showToast(data.message || 'Failed to load reports', 'error');
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                showToast('Failed to load reports', 'error');
            } finally {
                hideLoading('reports');
            }
        }

        // Update reports data
        function updateReportsData(reports) {
            document.getElementById('monthlyRevenue').textContent = reports.monthlyRevenue;
            document.getElementById('weeklyRevenue').textContent = reports.weeklyRevenue;
            document.getElementById('dailyRevenue').textContent = reports.dailyRevenue;
            
            document.getElementById('totalBookings').textContent = reports.totalBookings;
            document.getElementById('completedBookings').textContent = reports.completedBookings;
            document.getElementById('cancelledBookings').textContent = reports.cancelledBookings;
        }

        // Load messages
        async function loadMessages() {
            try {
                showLoading('messages');
                
                const response = await fetch(`${BASE_URL}api/get_contact_messages.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateMessagesList(data.data.messages);
                } else {
                    showToast(data.message || 'Failed to load messages', 'error');
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                showToast('Failed to load messages', 'error');
            } finally {
                hideLoading('messages');
            }
        }

        // Update messages list
        function updateMessagesList(messages) {
            const container = document.getElementById('messagesList');
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = '<p class="no-data">No messages found.</p>';
                return;
            }
            
            messages.forEach(message => {
                const messageItem = createMessageItem(message);
                container.appendChild(messageItem);
            });
        }

        // Create message item
        function createMessageItem(message) {
            const div = document.createElement('div');
            div.className = `message-item ${message.read ? 'read' : 'unread'}`;
            
            div.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${message.name}</span>
                    <span class="message-date">${message.date}</span>
                    ${!message.read ? '<span class="unread-badge">New</span>' : ''}
                </div>
                <div class="message-subject">${message.email}</div>
                <div class="message-preview">${message.message.substring(0, 100)}...</div>
                <div class="message-actions">
                    <button class="action-btn secondary" onclick="viewMessage('${message.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="action-btn primary" onclick="markAsRead('${message.id}')">
                        <i class="fas fa-check"></i> Mark Read
                    </button>
                </div>
            `;
            
            return div;
        }

        // Setup event listeners
        function setupEventListeners() {
            const addWorkerForm = document.getElementById('addWorkerForm');
            if (addWorkerForm) {
                addWorkerForm.addEventListener('submit', handleAddWorker);
            }
            
            const addPackageForm = document.getElementById('addPackageForm');
            if (addPackageForm) {
                addPackageForm.addEventListener('submit', handleAddPackage);
            }
            
            const assignWorkerForm = document.getElementById('assignWorkerForm');
            if (assignWorkerForm) {
                assignWorkerForm.addEventListener('submit', handleAssignWorker);
            }
            
            const updateStatusForm = document.getElementById('updateStatusForm');
            if (updateStatusForm) {
                updateStatusForm.addEventListener('submit', handleUpdateStatus);
            }
        }

        // Handle add worker
        async function handleAddWorker(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const workerData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                address: formData.get('address'),
                specialization: formData.get('specialization')
            };
            
            try {
                const response = await fetch(`${BASE_URL}api/add_worker.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workerData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Worker added successfully!', 'success');
                    closeAddWorkerModal();
                    loadWorkers();
                } else {
                    showToast(data.message || 'Failed to add worker', 'error');
                }
            } catch (error) {
                console.error('Error adding worker:', error);
                showToast('Failed to add worker', 'error');
            }
        }

        // Handle add package
        async function handleAddPackage(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const packageData = {
                name: formData.get('name'),
                description: formData.get('description'),
                carPrice: formData.get('carPrice'),
                bikePrice: formData.get('bikePrice'),
                duration: formData.get('duration')
            };
            
            try {
                const response = await fetch(`${BASE_URL}api/add_package.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(packageData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Package added successfully!', 'success');
                    closeAddPackageModal();
                    loadPackages();
                } else {
                    showToast(data.message || 'Failed to add package', 'error');
                }
            } catch (error) {
                console.error('Error adding package:', error);
                showToast('Failed to add package', 'error');
            }
        }

        // Handle assign worker
        async function handleAssignWorker(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const assignData = {
                bookingId: formData.get('bookingId'),
                workerId: formData.get('workerId'),
                notes: formData.get('notes')
            };
            
            try {
                const response = await fetch(`${BASE_URL}api/assign_worker.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(assignData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Worker assigned successfully!', 'success');
                    closeAssignWorkerModal();
                    loadBookings();
                } else {
                    showToast(data.message || 'Failed to assign worker', 'error');
                }
            } catch (error) {
                console.error('Error assigning worker:', error);
                showToast('Failed to assign worker', 'error');
            }
        }

        // Handle update status
        async function handleUpdateStatus(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const statusData = {
                bookingId: formData.get('bookingId'),
                status: formData.get('status'),
                notes: formData.get('notes')
            };
            
            try {
                const response = await fetch(`${BASE_URL}api/update_booking_status.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(statusData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Status updated successfully!', 'success');
                    closeUpdateStatusModal();
                    loadBookings();
                } else {
                    showToast(data.message || 'Failed to update status', 'error');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Failed to update status', 'error');
            }
        }

        // Modal functions
        function openAddWorkerModal() {
            document.getElementById('addWorkerModal').style.display = 'block';
            document.getElementById('addWorkerForm').reset();
        }

        function closeAddWorkerModal() {
            document.getElementById('addWorkerModal').style.display = 'none';
        }

        function openAddPackageModal() {
            document.getElementById('addPackageModal').style.display = 'block';
            document.getElementById('addPackageForm').reset();
        }

        function closeAddPackageModal() {
            document.getElementById('addPackageModal').style.display = 'none';
        }

        function assignWorker(bookingId) {
            document.getElementById('assignBookingId').value = bookingId;
            document.getElementById('assignWorkerModal').style.display = 'block';
            loadAvailableWorkers();
        }

        function closeAssignWorkerModal() {
            document.getElementById('assignWorkerModal').style.display = 'none';
            document.getElementById('assignWorkerForm').reset();
        }

        function updateStatus(bookingId) {
            document.getElementById('statusBookingId').value = bookingId;
            document.getElementById('updateStatusModal').style.display = 'block';
        }

        function closeUpdateStatusModal() {
            document.getElementById('updateStatusModal').style.display = 'none';
            document.getElementById('updateStatusForm').reset();
        }

        // Load available workers
        async function loadAvailableWorkers() {
            try {
                const response = await fetch(`${BASE_URL}api/get_admin_dashboard.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const workerSelect = document.getElementById('assignWorkerId');
                    workerSelect.innerHTML = '<option value="">Select a worker</option>';
                    
                    data.data.workers.forEach(worker => {
                        if (worker.status === 'Available') {
                            const option = document.createElement('option');
                            option.value = worker.id;
                            option.textContent = worker.name;
                            workerSelect.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading workers:', error);
            }
        }

        // View functions
        function viewBooking(bookingId) {
            showToast(`Viewing booking ${bookingId}`, 'default');
        }

        function viewWorker(workerId) {
            showToast(`Viewing worker ${workerId}`, 'default');
        }

        function editWorker(workerId) {
            showToast(`Editing worker ${workerId}`, 'default');
        }

        function viewPackage(packageId) {
            showToast(`Viewing package ${packageId}`, 'default');
        }

        function editPackage(packageId) {
            showToast(`Editing package ${packageId}`, 'default');
        }

        function deletePackage(packageId) {
            if (confirm('Are you sure you want to delete this package?')) {
                showToast(`Deleting package ${packageId}`, 'default');
            }
        }

        function viewCustomer(customerId) {
            showToast(`Viewing customer ${customerId}`, 'default');
        }

        function editCustomer(customerId) {
            showToast(`Editing customer ${customerId}`, 'default');
        }

        function viewMessage(messageId) {
            showToast(`Viewing message ${messageId}`, 'default');
        }

        async function markAsRead(messageId) {
            try {
                const response = await fetch(`${BASE_URL}api/mark_message_read.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ messageId: messageId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Message marked as read', 'success');
                    loadMessages();
                } else {
                    showToast(data.message || 'Failed to mark message as read', 'error');
                }
            } catch (error) {
                console.error('Error marking message as read:', error);
                showToast('Failed to mark message as read', 'error');
            }
        }

        // Loading functions
        function showLoading(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('loading');
            }
        }

        function hideLoading(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('loading');
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // Close modals with escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html> 